<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ForkNGo - Restaurant</title>

    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- App CSS -->
    <link rel="stylesheet" href="/styles/nav.css" />
    <link rel="stylesheet" href="/vendor/normalize-4.1.1.css" />
    <link rel="stylesheet" href="/vendor/border-box.css" />
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/cart-styles.css" />
    <link rel="stylesheet" href="/styles/orders_admin.css" />
    <!-- Scripts -->
    <script src="/vendor/jquery-3.0.0.js"></script>
    <script defer src="/scripts/app.js"></script>
  </head>

  <body>
    <header>
      <nav class="main-nav">
        <div class="nav-container">
            <div class="header-content">
              <h1>Welcome to ForkNGo </h1>
            </div>
            <div class="user-actions">
                <% if (user) { %>
                  <span class="user-name">Hi, <%= user.name %></span>
                    <a href="/logout" class="nav-button">Logout</a>
                <% } else { %>
                    <a href="/login" class="nav-button">Login</a>
                <% } %>
            </div>
        </div>
      </nav>
        <div class="order-title">
          <h2>Orders</h2>
        </div>

          <div class="order-container">
            <% ordersAdmin.forEach(order => { %>
              <div class="order">
                <div class="order-header" data-food-id="<%= order.id %>">

                  <p>Order ID: <%= order.id %></p><hr>
                  <p>Name: <%= order.name %></p><hr>
                  <p>Phone: #<%= order.phone %></p>
                </div>

                <div class="order"><% order.items.forEach(items => { %>
                  <div class="item">
                    <p><%= items.food_name %></p>
                    <p>Quantity: <%= items.qty %></p>

                  </div>
                  <% }) %>
                </div>
                  <!-- checking if order status is picked up. If picked up, make sure button is disabled -->
                  <!-- pass the order.id and the current order status -->
                  <!-- changes the button text by order status -->
                <button
                  id="status-btn-<%= order.id %>" class="button"
                    <% if (order.order_status === 'picked up') { %> disabled <% } %>
                    onclick="updateOrderStatus(<%= order.id %>, '<%= order.order_status %>')">
                      <%= order.order_status === 'received' ? 'Mark as in progress' :
                      order.order_status === 'in progress' ? 'Mark as ready for pick-up' :
                      order.order_status === 'ready for pick-up' ? 'Mark as picked up' :
                      'order completed' %>
                </button>
              </div>
            <% }) %>
          </div>
    </header>

    <footer>
      <p>ForkNGo Â© 2025</p>
    </footer>

    <script>
      async function updateOrderStatus(orderId, orderStatus) {
        const button = document.getElementById(`status-btn-${orderId}`) //getting the button by id
          let newStatus =""
          let buttonText = ""
            //checking for the current order status and updating new status and buttom text accordingly
                    
            if (orderStatus == "received") {
              newStatus = "in progress";
              buttonText = "Mark as ready for pick-up";
            } else if (orderStatus == "in progress") {
              newStatus = "ready for pick-up";
              buttonText = "Mark as  picked up";
            } else if (orderStatus == "ready for pick-up") {
              newStatus = "picked up";
              buttonText = "Order completed";
            };

        try{
          const response = await fetch('/update-status', { //fetch request for post
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId, newStatus })  //send order.id + status
          });

            button.disabled = true; //disabling the button so that the user can't click while it's updating
            button.innerText = "updating status" //changing the text so that the user knows that it's updating
              if (!response.ok) {
                throw new Error("Failed to update status");
              }

          const result = await response.json(); //waiting for the respond on the database update
            console.log("Server response:", result);
            button.innerText = buttonText; //changing the button text once the database is updated
            //updating the status on click function so that the next time user click, button works properly
            button.onclick = function () {
              updateOrderStatus(orderId, newStatus);
            };
            if(newStatus == "picked up") { //checking if new status is picked up and making sure the button is diabled or not
              button.disabled = true;
            } else {
              button.disabled = false;
            }
        } catch (error) {
            console.error("Error updating order status:", error);
        };
      };
    </script>
  </body>
</html>
