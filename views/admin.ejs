<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ForkNGo - Restaurant</title>

    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- App CSS -->
    <link rel="stylesheet" href="/styles/nav.css" type="text/css" />
    <link rel="stylesheet" href="/vendor/normalize-4.1.1.css" />
    <link rel="stylesheet" href="/vendor/border-box.css" />
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/layout.css" />
    <link rel="stylesheet" href="/styles/cart-styles.css" />

    <!-- Scripts -->
    <script src="/vendor/jquery-3.0.0.js"></script>
    <script defer src="/scripts/app.js"></script>
  </head>

  <body>
    <header>
        <div class="header-content">
          <h1>Welcome to ForkNGo ðŸ¥™</h1>

          <div class="user-actions">
            <% if (user) { %>
              <p class="nav-item nav-link">Logged in as: <%= user.name %></p>
                <a href="/logout" title="Link to logout">Logout</a>
              <% } else { %>
                <a href="/login" title="Link to login page">Login</a>
            <% } %>
          </div>
          
            <h2>Orders</h2>
              <div class="order-container">
                <% ordersAdmin.forEach(order => { %>
                    <div class="order">
                        <div class="order-header" data-food-id="<%= order.id %>">
                            
                            <p>Order ID: <%= order.id %></p><hr>   
                            <p>Name: <%= order.name %></p><hr>
                            <p>Phone: #<%= order.phone %></p>
                        </div>
                        
                        <div class="order"><% order.items.forEach(items => { %>
                            <div class="item">
                                <p><%= items.food_name %></p>
                                <p>Quantity: <%= items.qty %></p>
                                
                            </div>
                            <% }) %> 
                        </div>
                        <button id="status-btn-<%= order.id %>" onclick="updateOrderStatus(`<%= order.id %>`, `<%= order.order_status %>`)">
                            <%= order.order_status === 'received' ? 'Mark as in progress' : 
                                order.order_status === 'in progress' ? 'Mark as ready for pick-up' : 
                                order.order_status === 'ready for pick-up' ? 'Mark as picked up' : 
                                'order completed' %>
                          </button>
                    </div>
                <% }) %>
              </div>
            <div class="user-actions">
            
          </div>
        </div>
      </div>
  
    </header>

    <footer>
      <p>ForkNGo Â© 2025</p>
    </footer>
    <script>
        async function updateOrderStatus(orderId, orderStatus) {
            const button = document.getElementById(`status-btn-${orderId}`)

            let newStatus ="" 
            let buttonText = ""
    if (orderStatus == "received") {
      newStatus = "in progress";
      buttonText = "Mark as ready for pick-up";
    } else if (orderStatus == "in progress") {
      newStatus = "ready for pick-up";
      buttonText = "Mark as  picked up";
    } else if (orderStatus == "ready for pick-up") {
      newStatus = "picked up";
      buttonText = "Order completed";
    } 
    alert(newStatus)
    alert(orderStatus)
            try{
                const response = await fetch('/update-status', { //fetch request for post
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId, newStatus })  //send order.id and status
      });
    
      if (!response.ok) {
            throw new Error("Failed to update status");
        }

        const result = await response.json();
        console.log("Server response:", result);
        button.innerText = buttonText;

        } catch (error) {
        console.error("Error updating order status:", error);
        alert("An error occurred while updating order status.");
        }
        }

    </script>
  </body>
</html>
